version: 2

jorbs:
  build:
    docker:
      - image: alpine
    steps:
      - checkout 
      - run:
        name: Echo Test
        command: echo "CircleCI Test"
  # EC2 に SSH 接続・デプロイを実行
  deploy:
    machine:
      image: circleci/classic:edge
    steps:
      - checkout
      # CircleCIに登録した秘密鍵を呼び出す
      - add_ssh_keys:
      # CircleCIに登録した環境変数を使ってSSH ssh shrine@118.27.8.59 -p 22022
      - run: ssh ${URER_NAME}@${HOST_NAME} -p 22022 'cd /usr/share/nginx/html/auto-deploy-test && git pull'

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build
      - deploy:
        requires:
          # build ジョブに依存しているので、先にbuildジョブを実行
          - buld
        # master ブランチにpushされた場合のみ deploy
        filters:
          branches:
            only: master

